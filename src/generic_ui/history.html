<html>

<head>
  <script src="/third_party/bower/webcomponentsjs/webcomponents.js"></script>
  <link rel="import" href="/third_party/bower/core-menu/core-menu.html">
  <link rel="import" href="/third_party/bower/paper-button/paper-button.html">
  <link rel="import" href="/third_party/bower/paper-dropdown/paper-dropdown.html">
  <link rel="import" href="/third_party/bower/paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel='import' href='/third_party/bower/paper-item/paper-item.html'>
  <link rel='import' href='polymer/metrics-choice-view.html'>
  <link rel='import' href='polymer/welcome-view.html'>
  <style>
  </style>
</head>

<body>
  <div id='root-panel'></div>
  <script>
    'use strict';

    class Settings {
      constructor() {
        this.language = null;
      }
      setLanguage(language) {
        this.language = language;
      }
      enableMetrics(enable) {
        this.enableMetrics = enable;
      }
    }

    class RootPanel {
      // Takes the element that will be the root for this panel.
      constructor(root_node) {
        this.root_node_ = root_node;
        this.content_node_ = null;
      }
      setContent(content_node){
        if (this.content_node_ !== null) {
          this.root_node_.removeChild(this.content_node_);
        }
        this.content_node_ = content_node;
        this.root_node_.appendChild(content_node);
      }
    }

    class HomeViewUnwrapped extends HTMLElement {
      createdCallback() {
        this.innerHTML = '<h1>Home</h1>' +
          '<p><button>Get Access from Peer</button></p>' +
          '<p><button>Get Access from Cloud Proxy</button></p>' +
          '<p><button>Share Access</button></p>';
      }
    }
    const HomeView = document.registerElement('home-view', HomeViewUnwrapped);

    function main() {
      let settings = new Settings();

      let root_panel = new RootPanel(document.getElementById('root-panel'));

      // Clear current state.
      window.history.replaceState(null, null);

      let views = {};

      function pushView(key, view_element) {
        console.log('Push View: ', key);
        history.pushState({ view: key }, null, '#' + key);
        root_panel.setContent(view_element);
        views[key] = view_element;
      }

      window.addEventListener('popstate', function(event) {
        console.log("Pop state: " + JSON.stringify(event.state));
        if (event.state === null) {
          console.log('Settings: ', settings);
          pushView('home', new HomeView());
        } else {
          root_panel.setContent(views[event.state.view]);
        }
      });

      let welcome_view = new WelcomeView();
      welcome_view.onLanguageChosen((event) => {
        settings.setLanguage(event.detail);
      });
      welcome_view.onDone(() => {
        let choice_view = new MetricsChoiceView();
        choice_view.onMetricsChoiceMade((optIn) => {
          settings.enableMetrics(optIn);
        });
        choice_view.onDone(() => {
          history.go(-2);
        });
        pushView('metrics', choice_view)
      });
      pushView('welcome', welcome_view);
    }

    window.addEventListener('polymer-ready', main);
  </script>
</body>
</html>